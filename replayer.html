<html>
   <head>
      <meta charset='UTF-8'>
      <script src='../canvas-rr/rr-replay.js'></script>
      <script src='gl-2d.js'></script>
   </head>
   <body>
Recording: <input id='fileInput' type='file' accept='.json'
                  onchange='file_input_changed(this.files[0])'/>
<br/>
Status: <span id='e_status'>-</span>

<hr/>
<button onclick='reset_button()'>Reset</button>
<button onclick='play_button()'>Play</button>
<hr/>
<div id='e_sandbox'></div>
<script>

let RECORDING = null;

async function file_input_changed(blob) {
   const start = performance.now();
   let last_split = start;

   function log_split(text) {
      let split = performance.now();
      const split_diff = split - last_split;
      const total_diff = split - start;
      console.log(`[${split_diff|0}/${total_diff|0}ms]`, text);
   }

   e_status.textContent = 'Reading...';
   const text = await blob.text();
   log_split(`Read ${text.length} bytes.`);

   e_status.textContent = 'Parsing...';
   const json = JSON.parse(text);
   log_split('Parsed.');

   e_status.textContent = 'Loading...';
   RECORDING = await Recording.from_json(json);
   log_split(`Loaded ${RECORDING.frames.length} frames.`);

   e_status.textContent = 'Ready.';
}

function remove_all_children(elem) {
   while (elem.firstChild) {
      elem.removeChild(elem.firstChild);
   }
}

function reset_button() {
   remove_all_children(e_sandbox);

   const elem_map = RECORDING.make_elems();
   RECORDING.elem_map = elem_map;

   for (const k in elem_map) {
      const elem = elem_map[k];
      if (elem.constructor.name !== 'HTMLCanvasElement') continue;

      const e_elem_title = document.createElement('div');
      e_elem_title.textContent = k + ':';
      e_sandbox.appendChild(e_elem_title);

      elem.style.border = '1px solid black';
      e_sandbox.appendChild(elem);
   }
}

function play_button() {
   reset_button();
   RECORDING.play(RECORDING.elem_map, 0);
}

</script>
   </body>
</html>
